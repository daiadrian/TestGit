Docker常用操作

## Docker 简介

​		Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中，然后发布到任何流行的 Linux 或 Windows 机器上。使用 Docker 可以更方便低打包、测试以及部署应用程序

> 通俗易懂：
>
> ​		用户构建一个镜像，然后通过docker拉取镜像到本地，然后通过运行镜像就能启动一个docker容器了
>
> ​		以nginx为例，docker拉取 nginx 的镜像到本地，运行这个镜像后，就会有一个nginx部署到本机上了，而这个nginx就是一个进程
>
> ​		如果部署了nginx、mysql、tomcat，他们之间是不同进程，并不在同一个容器内，而是多个容器部署在同一个机器中；在这个机器中，这三个应用是相互隔离的，但是共用该Linux系统的资源

​		Docker 属于 Linux 容器的一种封装，提供简单易用的容器使用接口。Docker 将应用程序与该程序的依赖，打包在一个文件里面（也就是镜像）。运行这个文件，就会生成一个虚拟容器。程序在这个虚拟容器里运行，就好像在真实的物理机上运行一样

​		Docker 在容器的基础上，进行了进一步的封装，从文件系统、网络互联到进程隔离等等，极大的简化了容器的创建和维护。使得 Docker 技术比虚拟机技术更为轻便、快捷

​		Docker 容器的启动可以在秒级实现，这相比传统的虚拟机方式要快得多；Docker 对系统资源的利用率很高，**一台主机上可以同时运行数千个 Docker 容器**



## Docker相关概念

### 架构

Docker是CS架构，主要有两个概念：

- **Docker daemon**: 运行在宿主机上，Docker守护进程，用户通过Docker client（Docker命令）与Docker daemon交互
- **Docker client**: Docker 命令行工具，是用户使用Docker的主要方式，Docker client与Docker daemon通信并将结果返回给用户，Docker client也可以通过socket或者RESTful api访问远程的Docker daemon

### 组成

- **Docker image**：镜像是只读的，镜像中包含有需要运行的文件。<font color=blue>**镜像用来创建container，一个镜像可以运行多个 container**</font>；镜像可以通过 Dockerfile 创建，也可以从Docker hub/registry上下载
- **Docker container**：容器是Docker的运行组件，<font color=red>**启动一个镜像就是一个容器**，容器是一个隔离环境，多个容器之间不会相互影响</font>，保证容器中的程序运行在一个相对安全的环境中
- **Docker hub/registry**: 共享和管理Docker镜像，用户可以上传或者下载上面的镜像，官方地址为`https://registry.hub.docker.com/`，也可以搭建自己私有的Docker registry



## Docker 环境安装

- 安装yum-utils：

  ```bash
  yum install -y yum-utils device-mapper-persistent-data lvm2
  ```

- 为yum源添加docker仓库位置：

  ```bash
  yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  ```

- 安装docker:

  ```bash
  yum install docker-ce
  ```

- 启动docker:

  ```bash
  systemctl start docker
  ```

## Docker 镜像常用命令

### 镜像相关操作

#### 搜索镜像

```bash
docker search java
```

#### 下载镜像

```bash
docker pull java:8
```

#### 如何查找镜像支持的版本

> ​		由于docker search命令只能查找出是否有该镜像，不能找到该镜像支持的版本，所以我们需要通过docker hub来搜索支持的版本。

- 进入docker hub的官网，地址：[https://hub.docker.com](https://hub.docker.com/)

- 然后搜索需要的镜像

- 查看镜像支持的版本

- 进行镜像的下载操作

  ```bash
  docker pull nginx:1.17.0
  ```

#### 列出镜像

```bash
docker images
```

#### 删除镜像

- 指定名称删除镜像

  ```bash
  docker rmi java:8
  ```

- 指定名称删除镜像（强制）

  ```bash
  docker rmi -f java:8
  ```

- 强制删除所有镜像

  ```bash
  docker rmi -f $(docker images)
  ```

### 容器常用命令

#### 新建并启动容器

```bash
docker run -p 80:80 --name nginx -d nginx:1.17.0
```

- -d选项：表示后台运行
- --name选项：指定运行后容器的名字为nginx,之后可以通过名字来操作容器
- -p选项：指定端口映射，格式为：hostPort:containerPort

#### 查看运行/所有容器

- 列出<font color=red>运行中</font>的容器

  ```bash
  docker ps
  ```

- <font color=green>**列出所有容器**</font>

  ```bash
  docker ps -a
  ```

#### 停止容器

```bash
# $ContainerName及$ContainerId 可以用docker ps命令查询出来
docker stop $ContainerName
docker stop $ContainerId
```

比如：

```bash
docker stop nginx
#或者
docker stop c5f5d5125587
```

**强制停止容器**

```bash
docker kill $ContainerName
docker kill $ContainerId
```



#### 启动容器

```bash
docker start $ContainerName
docker start $ContainerId
```



#### 进入容器

- 先查询出容器的pid

  ```bash
  docker inspect --format "{{.State.Pid}}" $ContainerName
  docker inspect --format "{{.State.Pid}}" $ContainerId
  ```

- 根据容器的pid进入容器

  ```bash
  nsenter --target "$pid" --mount --uts --ipc --net --pid
  ```

例如：

```shell
docker inspect --format "{{.State.Pid}}" nginx
7777
nsenter --target 7777 --mount --uts --ipc --net --pid
#这样就能进入容器的内部了
```

#### 删除容器

- 删除指定容器：

  ```bash
  docker rm $ContainerName
  docker rm $ContainerId
  ```

- 强制删除所有容器；

  ```bash
  docker rm -f $(docker ps -a -q)
  ```

#### 查看容器的日志

- 查看当前全部日志

  ```bash
  docker logs $ContainerName
  docker logs $ContainerId
  ```

- 动态查看日志

  ```bash
  docker logs $ContainerName -f
  docker logs $ContainerId -f
  ```

#### 查看容器IP地址

```shell
docker inspect --format '{{ .NetworkSettings.IPAddress }}' $ContainerName

docker inspect --format '{{ .NetworkSettings.IPAddress }}' $ContainerId
```

#### 容器同步宿主机时间

```bash
docker cp /etc/localtime $ContainerName:/etc/
```

#### 宿主机查看docker使用的CPU、内存、网络和IO情况

- 查看指定容器情况

  ```bash
  docker stats $ContainerName
  docker stats $ContainerId
  ```

- 查看所有容器情况

  ```bash
  docker status -a
  ```

#### 进入容器内部的bash

```bash
docker exec -it $ContainerName /bin/bash
```



