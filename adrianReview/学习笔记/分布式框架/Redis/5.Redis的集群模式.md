## Redis的集群模式

### 主从复制

`Redis` 的主从复制功能分为两种数据同步模式进行：全量数据同步和增量数据同步

#### 全量数据同步

​		请求 master `BgSave` 出自己的一个 `RDB Snapshot` （快照）文件发给slave，slave接收完毕后，清除掉自己的旧数据，然后将RDB载入内存

#### 增量数据同步

​		master作为一个普通的client连入slave，将所有写操作转发给slave，没有特殊的同步协议



#### 主从复制原理

主从复制主要是：salve启动的时候先进行一次全量数据同步，然后后续master的写操作都会在salve上执行一次

1. 从服务器连接主服务器，发送 `SYNC` 命令； 

2. 主服务器接收到 `SYNC` 命令后，开始执行 `BGSAVE` 命令生成 `RDB` 文件并使用缓冲区记录此后执行的所有写命令； 

3. 主服务器 `BGSAVE` 执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令； 

4. 从服务器收到快照文件后丢弃所有旧数据，载入收到的快照； 

5. 主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令； 

6. 从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令（**从服务器初始化完成**）

7. 主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令（**从服务器初始化完成后的操作**）

![5.主从复制1](.\images\5.主从复制1.png)



#### 主从复制优缺点

**优点：**

- 主机会自动将数据同步到从机，可以进行读写分离
- 为了分载Master的读操作压力，Slave服务器可以为客户端提供只读操作的服务，写服务仍然必须由Master来完成
- Slave同样可以接受其它Slaves的连接和同步请求，这样可以有效的分载Master的同步压力
- Master Server是以非阻塞的方式为Slaves提供服务。所以在Master-Slave同步期间，客户端仍然可以提交查询或修改请求。
- Slave Server同样是以非阻塞的方式完成数据同步。在同步期间，如果有客户端提交查询请求，`Redis` 则返回同步之前的数据

**缺点：**

- `Redis` 不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换前端的 `IP` 才能恢复

- 主机宕机，宕机前有部分数据未能及时同步到从机，切换 `IP` 后还会引入数据不一致的问题，降低了系统的可用性

- `Redis` 的主从复制采用全量复制，复制过程中主机会fork出一个子进程对内存做一份快照，并将子进程的内存快照保存为文件发送给从机，这一过程需要确保主机有足够多的空余内存

  > ​		若快照文件较大，对集群的服务能力会产生较大的影响
  >
  > ​		而且复制过程是在从机新加入集群或者从机和主机网络断开重连时都会进行，也就是网络波动都会造成主机和从机间的一次全量的数据复制

- `Redis` 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂

#### 主从复制配置

主要参数项说明：

1. `slaveof <masterip> <masterport>` 例如：`slaveof 192.168.1.1 6379`

2. `slave-serve-stale-data` ：当master节点断开和当前salve节点的连接或者当前slave节点正在进行和master节点的数据同步时，如果收到了客户端的数据读取请求，**slave服务器是否使用陈旧数据向客户端提供服务**。该参数的默认值为yes

3. `slave-read-only`：是否将salve节点设置为“只读”。一旦设置为“只读”，表示这个Salve节点只会进行数据读取服务，<font color=blue>如果客户端直接向这个Salve节点发送写数据的请求，则会收到**错误提示**</font>

4. `repl-ping-slave-period`：Slave节点向Master节点发送ping指令的事件间隔，默认为10秒

5. `slave-priority`：当前Slave节点的优先级权重。在 `Redis` 自带的监控和故障转移工具 `Redis Sentinel` 中，允许一个Master节点下有多个Slave节点，并且可以自动切换Slave节点为Master节点。<font color=blue>如果Slave节点的优先级权重值越低，就会再切换时有限成为新的Master节点</font>

6. `repl-timeout`：超时时间，当某些操作达到这个时间时，Master和Slave双方都会认为对方已经断开连接

   > - 向Slave进行的数据同步操作本身不能超过这个时间
   > - Slave向Master发送一个 `PING` 指令并等待响应的时间
   > - Master向Slave发送 `PONG` 回复并等待 `ACK` 的时间



### 哨兵模式(Sentinel)

​		`Sentinel`（哨兵）进程是用于监控 `Redis`集群中Master主服务器工作的状态，在Master主服务器发生故障的时候，可以实现Master和Slave服务器的切换，保证系统的高可用

#### 哨兵进程的作用

1. 监控（Monitoring）：哨兵（Sentinel）会不断地检查你的Master和Slave是否运作正常。

2. 提醒（Notification）：当被监控的某个 `Redis`节点出现问题时，哨兵（Sentinel） 可以通过 `API` 向管理员或者其他应用程序发送通知

3. 自动故障迁移（`Automatic failover`）：当一个Master不能正常工作时，哨兵（Sentinel） 会开始一次自动故障迁移操作：

   1. 它会将失效Master的其中一个Slave升级为新的Master，并让失效Master的其他Slave改为复制新的Master；当客户端试图连接失效的 Master 时，集群也会向客户端返回新 Master 的地址，使得集群可以使用现在的 Master 替换失效 Master

   2. Master和Slave服务器切换后，Master的 `Redis.conf`、Slave的 `Redis.conf` 和  `Sentinel.conf`的配置文件的内容都会发生相应的改变，即 Master 主服务器的 `Redis.conf` 配置文件中会多一行`slaveof` 的配置，`Sentinel.conf` 的监控目标会随之调换



#### Sentinel进程的工作方式

1. 每个Sentinel（哨兵）进程以每秒钟一次的频率向整个集群中的 Master 主服务器，Slave从服务器以及其他 Sentinel（哨兵）进程发送一个 PING 命令

2. 如果一个实例距离最后一次有效回复 PING 命令的时间超过`down-after-milliseconds` 选项所指定的值， 则这个实例会被 Sentinel（哨兵）进程标记为<font color=red>**主观下线**（`SDOWN`）</font>

   - 如果一个Master主服务器被标记为主观下线（`SDOWN`），则正在监视这个Master主服务器的所有 Sentinel（哨兵）进程要以<font color=blue>每秒一次</font>的频率确认Master主服务器的确进入了主观下线状态

   - 当有**足够数量的 Sentinel（哨兵）进程**（超过 `quorum`（选举）个数）在指定的时间范围内确认Master 主服务器进入了主观下线状态（`SDOWN`），则Master主服务器会被标记为客观下线（`ODOWN`）

3. 在一般情况下， 每个 Sentinel（哨兵）进程会以每 10 秒一次的频率向集群中的所有 Master主服务器、Slave 从服务器发送 `INFO` 命令

4. 当Master主服务器被 Sentinel（哨兵）进程标记为客观下线（`ODOWN`）时，Sentinel（哨兵）进程向下线的 Master主服务器的所有 Slave 从服务器发送 `INFO` 命令的频率会从 10 秒一次改为每秒一次

5. 若没有足够数量的 Sentinel（哨兵）进程同意 Master 主服务器下线， Master 主服务器的客观下线状态就会被移除。若 Master主服务器重新向 Sentinel（哨兵）进程发送 `PING` 命令返回有效回复，Master主服务器的主观下线状态就会被移除

#### 哨兵模式的优缺点

**优点：**

- 哨兵集群模式是基于主从模式的，所有主从的优点，哨兵模式同样具有
- 主从可以切换，故障可以转移，系统可用性更好
- 哨兵模式是主从模式的升级，系统更健壮，可用性更高

**缺点：**

- `Redis` 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。为避免这一问题，运维人员在系统上线时必须确保有足够的空间，这对资源造成了很大的浪费
- 配置复杂



### Redis Cluster集群

