## MySQL索引

### 什么是索引	

​		索引是对数据库表中一列或多列的值进行排序的一种结构，使用索引可快速访问数据库表中的特定信息。索引的作用相当于图书的目录，可以根据目录中的页码快速找到所需的内容

#### 索引的好处

1. 提高数据的检索的效率
2. **降低数据库的IO成本**
3. 降低数据库排序的成本
4. **降低CPU的消耗**

#### 索引的缺点

​		索引实际上也是一张表（保存主键和索引字段），索引是占用一定空间的。对于**经常update\delete\insert的表**来说，建立索引可能会**降低更新表的速度**，因为同时还要更新索引表

​		因为大多数Mysql 使用的默认存储引擎的数据结构是 **B+ 树**。B+树是一颗平衡树，如果我们对这颗树增删改的话，那肯定会**破坏它的原有结构；要维持平衡树，就必须做额外的工作**。正因为这些额外的工作开销，导致索引会降低增删改的速度

#### 需要创建索引的情况

- 表数据较大且经常用于查询操作，同时增删改操作较少的表
- 查询中频繁进行统计和分组的字段应该创建索引
- 查询中和其他表建立关联的字段
- 查询中进行排序的字段，排序字段通过索引去访问将大大提高排序速度

#### 不适合创建索引的情况

- 记录太少的表
- 频繁进行增删改操作的表（需要同时维护索引表）
- 数据列重复内容过多的字段不应该创建索引，这种情况不会有很大的效果



### 索引的种类

#### B+ 树索引

​		B+树是**平衡树**的一种；是不会退化成链表的，树的高度都是相对比较低的（基本符合**矮矮胖胖(均衡)的结构**）这样一来我们检索的时间复杂度就是O(logn)

> 平衡树：它是一棵空树或它的左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一棵平衡二叉树

- 因为不再需要进行全表扫描，只需要对树进行搜索即可，所以查找速度快很多

- 因为 B+ Tree 的有序性，所以除了用于查找，还可以用于排序和分组

- 可以指定多个列作为索引列，多个索引列共同组成键
- 适用于全键值、键值范围和键前缀查找，其中**键前缀查找只适用于最左前缀查找**。如果不是按照索引列的顺序进行查找，则无法使用索引
- InnoDB 的 B+Tree 索引分为主索引和辅助索引
  - 主索引的叶子节点 data 域记录着完整的数据记录，这种索引方式被称为**聚簇索引**。因为无法把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引
  - 辅助索引的叶子节点的 data 域记录着主键的值，因此在使用辅助索引进行查找时，需要先查找到主键值，然后再到主索引中进行查找

#### 

#### 哈希索引

​		哈希索引就是采用一定的**哈希算法**，把键值换算成新的哈希值，检索时不需要类似B+树那样从根节点到叶子节点逐级查找，只需一次哈希算法即可**立刻定位到相应的位置，速度非常快**

>  本质上就是**把键值换算成新的哈希值**，根据这个**哈希值来定位**

<font color=red>哈希索引的局限性</font>

- 哈希索引也没办法利用索引完成**排序**
- 不支持**最左匹配原则**
- 在有大量重复键值情况下，哈希索引的效率也是极低的---->**哈希碰撞**问题。
- **不支持范围查询**

##### InnoDB支持哈希索引吗？

​		主流的还是使用**B+树索引比较多**，对于哈希索引，**InnoDB是自适应哈希索引**的

​		hash索引的创建由InnoDB存储引擎引擎自动优化创建，我们干预不了

#### 全文索引（FullText）

​		MyISAM 存储引擎支持全文索引，用于查找文本中的关键词，而不是直接比较是否相等。查找条件使用 MATCH AGAINST，而不是普通的 WHERE。

​		全文索引使用倒排索引实现，它记录着关键词到其所在文档的映射。

>  InnoDB 存储引擎在 MySQL 5.6.4 版本中也开始支持全文索引

#### 空间数据索引（RTree）

​		MyISAM 存储引擎支持空间数据索引（R-Tree），可以**用于地理数据存储**。空间数据索引会从所有维度来索引数据，可以有效地使用任意维度来进行组合查询。

必须使用 GIS 相关的函数来维护数据



### 聚集索引和非聚集索引

1. 聚集索引就是以**主键**创建的索引
   - 聚集索引在叶子节点存储的是**表中的数据**

2. 非聚集索引就是以**非主键**创建的索引

   - 非聚集索引在叶子节点存储的是**主键和索引列**
   - 使用非聚集索引查询出数据时，**拿到叶子上的主键再去查到想要查找的数据**。(拿到主键再查找这个过程叫做**回表**)
   - <font color=blue>非聚集索引在建立的时候也**未必是单列**的，可以多个列来创建索引；创建多个单列（非聚集）索引的时候，会生成多个索引树（所以过多创建索引会占用磁盘空间）</font>

3. 覆盖索引（特殊的非聚集索引）

   - 覆盖索引就是把要<font color=red>查询出的列和索引是对应的，不做回表操作</font>（就是 `SELECT` 后面需要查询的 数据列 和 索引 对应）

   > 创建了索引`(username,age)`，在查询数据的时候：
   >
   > `select username , age from user where username = 'Java3y' and age = 20`
   >
   > 这个查询是走索引的，并且，**要查询出的列在叶子节点都存在**



### 最左匹配原则

​		如果是联合索引（多个列的组合索引），索引只能用于查找列是否相等，<font color=red>但是遇到范围查询（ `>`、`<`、`between` 和 `like`）就会停止继续匹配</font>

> 例如：
>
> 1. 如果建立（a,b）顺序的索引
>    - `where b=2` 是匹配不到（a,b）索引的；
>    - 但是如果查询条件是 `where a = 1 and b = 2` 或者 `where a=1`  又或者是 `where b = 2 and a = 1` 就可以匹配到该索引，因为优化器会自动调整a,b的顺序
>
> 2. 如果建立（a,b,c,d）顺序的索引，
>    - `where a = 1 and b = 2 and c > 3 and d = 4 `  中d是用不到索引的，因为c字段是一个范围查询，它之后的字段会停止匹配

**索引失效的情况**

- 索引列做（计算、函数或者类型转换）操作会导致索引失效

- 使用 `!=`、`<>`、`is null` 、`is not null` 都会导致索引失效

- `like` 关键字以 % 通配符开头会导致索引失效，即`name like '%abc' `

  > 注意：`where name like 'abc%'` 这种情况是使用到索引的
  >
  > 解决 like 导致索引失效的办法
  >
  > - 查询的字段是 **主键** 的时候，即使通配符开头也可以使用到索引
  > - 使用 **覆盖索引** （即查询列是 like 的字段）

- 使用 `or` 连接条件时会导致索引失效

- 字符串不加单引号，索引会失效



### Explain执行计划

重要字段：`select_type ` 、`key` 和 `rows`



1. `id ` ：表示查询中执行`SELECT`子句或操作表的顺序
   - id相同，执行顺序由上至下
   - id不同，如果是子查询，id会递增且id值越大优先级越高，越会先被执行
2. <font color=red>`select_type` </font>：主要用于区别查询类型，有简单查询、联合查询、子查询等
   - `SIMPLE`：简单的select查询，不包含子查询或者UNION
   - `PRIMARY`：查询中包含子查询，最外层查询就是primary
   - `SUBQUERY`：在select或where中包含子查询
   - `DERIVED`：在from中包含子查询会被标记为 derived。mysql 会递归执行这些子查询，结果放到临时表中
   - `UNION`：若第二个select 出现在union之后，则被标记为union。若union包含在from子句的子查询中，外层select将被标记为`derived`
   - `UNION RESULT`：从 union 表获取结果的select
3. `type`：访问类型；最好到最差排序：`system > const > eq_ref > ref > range > index > all`
   - `system`：表只有一条记录
   - `const`：通过索引一次就找到的记录，通常主键查询就是这种类型
   - `eq_ref`：唯一性索引扫描，对于每一个索引键，表中只有一条记录与之匹配
   - `ref`：非唯一性索引扫描，即可能会找到多个符合条件的行
   - `range`：索引列使用了范围性的关键字查询（`>、<、between、in`等）
   - `index`：只遍历的索引树，而非遍历全表数据
   - `all`：遍历全表
4. `possible_keys`：可能用到的索引，但不一定会被使用
5. <font color=red>`key`</font>：实际使用到的索引。为NULL时表示没用索引
6. <font color=red>`rows`：根据表统计信息及索引选用情况，大致估算找到记录所需要读取的行数</font>
7. `Extra`：额外信息
   - `Using filesort`：无法使用索引的情况，文件排序
   - `Using temporary`：使用了临时表保存中间结果，常见`order by` 和 `group by`
   - `Using index`：使用了索引，效率不错
   - `Using where`：使用了where过滤





