车商家重构项目总结

### 为什么需要重构（针对车商家）

1. **扩展性达到瓶颈**

   > ​		如果需要增加整体的处理能力，只能进行**横向扩展**，但是每次横向扩展都需要部署整一套完整项目，消耗的成本是巨大的
   >
   > ​		假如是对某个模块需要进行扩展处理的，其他模块也同样要进行扩展的，这样得到的效果是浪费了很多空间和资源
   >
   > ​		进行微服务重构，在分模块部署之后，只需要对单独模块进行横向扩展，吞吐量下来的时候可以适当的添加相应的资源增加该模块的处理能力



2. **针对并发的情况**

   > 跟第一点差不多。某个接口的处理能力跟机器的数量有关系（旧架构）
   >
   > 替换成新架构之后，可以增加接口对应模块的数量部署，增加吞吐量以应对突然的并发请求；同时可以在并发请求过去之后适当减少该模块的数量，以便资源的合理利用		



3. **系统模块解耦**

   > ​		旧架构中，模块之间的耦合性很强，当需要对权限之类的内容进行改动的时候，同时还需要对人员相关内容进行更新才能增加新的内容，这样的强耦合会导致更新一个内容的时候所要做的处理会很多很繁琐，而且影响的地方还需要时间去找寻
   >
   > ​		更新成新架构之后，只需要对权限模块进行更新，这些更新对人员模块是透明的，他们之间使用消息队列进行解耦，相应的业务逻辑更新不会相互影响



4. **提高系统安全性**

   > 旧系统出现的问题：线索泄漏，线索安全性低
   >
   > 旧系统对这方面的补救操作：对各个入口进行手机号码加密，对查询的接口进行解密监控（监控：记录对应人员的查询操作，查询的位置，查询的内容，时间进行记录；以便泄漏时可以查询到该线索在哪里被泄漏）同时增加钓鱼模块（手机号码转换，姓名转换模块）
   >
   > ​		**新架构后的处理：**更新成新架构后，可以统一这些的入口；在旧架构对这些的维护花的时间和人力都要很多，同时要增加新入口的话要同步增加加解密和监控操作。更新成新架构后，统一的线索量查询的搜索引擎，查询都在该模块进行，对手机号码转换和监控全在该模块，即使外部的入口增加，不影响这些模块的内容





### 分布式事务

人员模块和权限模块的分布式事务：

1. `kafka` 消息队列实现最终一致性
2. 保证消息不会丢失
   - 人员模块开启应答机制，收到应答 `ack` 后才算正常的发送成功，否则继续重试
   - 权限模块开启应答机制，在正常处理完事务后再发送 `ack` 应答
   - `kafka` 开启高可用，全部 `follower` 都收到该消息之后再应答发送方，以免 `master` 宕机的时候发生消息丢失的问题
3. 保证消息不会丢失的时候很容易超时导致消息重发
   - 权限模块中，权限和销售的关系表中使用唯一约束（销售ID和权限ID），保证数据的唯一性；即使重复消费了也不会影响数据
4. 操作数据的功能均记录操作日志，对于异常的数据可以查看操作日志来定位错误位置

