# 主从复制

`Redis` 的主从复制功能分为两种数据同步模式进行：全量数据同步和增量数据同步



主从复制的作用主要有：

1. <font color=blue>数据冗余</font>
   - 主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式
2. <font color=blue>故障恢复</font>
   - 当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复
   - 实际上是一种服务的冗余
3. <font color=blue>负载均衡</font>
   - 在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点），分担服务器负载
   - 尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量
4. <font color=blue>读写分离</font>
   - 可以用于实现读写分离，主库写、从库读，读写分离不仅可以提高服务器的负载能力，同时可根据需求的变化，改变从库的数量
5. <font color=blue>高可用的基石</font>
   - 主从复制是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础



## 全量数据同步

​		请求 master `BgSave` 出自己的一个 `RDB Snapshot` （快照）文件发给slave，slave接收完毕后，清除掉自己的旧数据，然后将RDB载入内存



## 增量数据同步

​		master作为一个普通的 client 连入 slave，将所有写操作转发给 slave，没有特殊的同步协议



## 主从复制原理

salve 启动的时候先进行一次全量数据同步，然后后续master的写操作都会在salve上执行一次

详细过程如下：

1. 从服务器连接主服务器，发送 `PSYNC` 命令； 

2. 主服务器接收到 `PSYNC` 命令后，开始执行 `BGSAVE` 命令生成 `RDB` 文件并使用缓冲区记录此后执行的所有写命令； 

3. 主服务器 `BGSAVE` 执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令； 

4. 从服务器收到快照文件后丢弃所有旧数据，载入收到的快照； 

5. 主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令； 

6. 从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令（**从服务器初始化完成**）

7. 主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令（**从服务器初始化完成后的操作**）

![5.主从复制1](.\images\5.主从复制1.png)



## 主从复制优缺点

### **优点：**

- 主机会自动将数据同步到从机，可以进行读写分离
- 为了分载Master的读操作压力，Slave服务器可以为客户端提供只读操作的服务，写服务仍然必须由Master来完成
- Slave同样可以接受其它Slaves的连接和同步请求，这样可以有效的分载Master的同步压力
- Master Server是以非阻塞的方式为Slaves提供服务。所以在Master-Slave同步期间，客户端仍然可以提交查询或修改请求。
- Slave Server同样是以非阻塞的方式完成数据同步。在同步期间，如果有客户端提交查询请求，`Redis` 则返回同步之前的数据



### **缺点：**

- `Redis` 不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换前端的 `IP` 才能恢复

- 主机宕机，宕机前有部分数据未能及时同步到从机，切换 `IP` 后还会引入数据不一致的问题，降低了系统的可用性

- `Redis` 的主从复制采用全量复制，复制过程中主机会fork出一个子进程对内存做一份快照，并将子进程的内存快照保存为文件发送给从机，这一过程需要确保主机有足够多的空余内存

  > ​		若快照文件较大，对集群的服务能力会产生较大的影响
  >
  > ​		而且复制过程是在从机新加入集群或者从机和主机网络断开重连时都会进行，也就是网络波动都会造成主机和从机间的一次全量的数据复制

- `Redis` 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂





## 主从复制配置详解

<font color=red>5.0 版本使用 `REPLICAOF` 代替了之前版本的 `SLAVEOF` ，如果使用5.0及之后版本，则建议新命令`REPLICAOF` </font>

主要参数项说明（配置文件）：

> 在 Redis Client 的控制窗口通过  info replication 命令可以看到复制的一些信息

```xml
slaveof <masterip> <masterport>
replicaof <masterip> <masterport>
<!-- 
	slaveof 192.168.1.1 6379
 	作为哪个redis服务的从节点
-->


slave-serve-stale-data yes
replica-serve-stale-data yes
<!-- 
	当 master 节点断开和当前 salve 节点的连接或者当前 slave 节点正在进行和 master 节点的数据同步时，如果收到了客户端的数据读取请求，slave 服务器是否使用陈旧数据向客户端提供服务
	默认是 yes
-->    

    
slave-read-only yes 
replica-read-only yes
<!-- 
	是否将 salve 节点设置为“只读”
	一旦设置为“只读”，表示这个Salve节点只会进行数据读取服务，如果客户端直接向这个Salve节点发送写数据的请求，则会收到错误提示
-->     
    
repl-ping-slave-period 10
<!-- 
	默认但是是秒
	Slave节点向Master节点发送ping指令的事件间隔
-->       
    
    
slave-priority 100
replica-priority 100
<!-- 
	当前Slave节点的优先级权重
	如果Slave节点的优先级权重值越低，就会再切换时优先成为新的Master节点
-->      
  
    
repl-timeout 60    
<!-- 
超时时间，当某些操作达到这个时间时，Master 和 Slave 双方都会认为对方已经断开连接 (单位: 秒)
	1.向Slave进行的数据同步操作本身不能超过这个时间
	2.Slave向Master发送一个 PING 指令并等待响应的时间
	3.Master向Slave发送 PONG 回复并等待 ACK 的时间
-->       
    
```



