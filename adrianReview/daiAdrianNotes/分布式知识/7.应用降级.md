# 应用降级

​		降级的最终目的是保证核心服务可用，即使是有损的。降级也需要根据系统的吞吐量、响应时间、可用率等条件进行手工降级或者自动降级



# 降级预案

降级按照是否自动化可以分为：自动开关降级和手工开关降级

降级按照功能可分为：读服务降级和写服务降级

降级按照处于系统层次可分为：多级降级



## 常见的降级方式

1. 页面降级
   - 某些占用了稀缺后端资源的页面可以对其进行降级处理
2. 页面异步请求降级
   - 比如页面一些推荐等异步加载的请求，如果响应慢或者后端服务有问题，可以对其进行降级
3. 服务功能降级
   - 比如调用商品详情页，可以对分类、热销榜等服务如果异常的话，可以直接降级处理
4. <font color=red>**读降级**</font>
   - 多级缓存模式，如果后端服务出现问题，可以降级为只读缓存。这种方式适用于对读一致性不强的应用场景
   - 页面静态化，定时推送静态页到缓存或者磁盘中，出现问题时切换过去
5. <font color=red>**写降级**</font>
   - 比如秒杀活动，可以对 cache 缓存进行更新。然后再异步扣减库存到DB，保证最终一致性即可
6. 爬虫降级
   - 可以将爬虫流量导向静态页或者返回空数据，从而保护后端稀缺资源
7. 风控降级
   - 对于高并发场景，可以增加验证码输入等功能来过滤机器人等高风险用户



## 自动开关降级

1. 超时降级

   - 访问数据库、HTTP服务、远程调用等响应速度慢或者超时，如果该服务不是核心服务，那么可以在其超时后自动降级（注意：要配置好超时时间和重试机制）

     

2. 统计失败次数降级

   - 一些 API 失败的调用次数到达配置的阈值后会自动降级（熔断器）

   - 通过异步线程去检测服务是否恢复可用

     

3. 故障降级

   - 远程服务挂掉了（网络故障、DNS故障、HTTP服务返回错误的状态、RPC调用抛出异常）可以直接降级处理

   - 处理的方案：返回默认数据、兜底数据、缓存（之前的缓存数据）

     

4. 限流降级

   - 当流量达到阈值的时候，后续的请求会被限流
   - 限流的方案：排队等待、错误页、重新刷新页



## 人工开关降级

​		开关可以存放到配置文件、数据库、Redis/Zookeeper中

​		当需要进行开关降级时，比如切换新旧服务、切换不同机房的服务、同步处理方式切换异步等操作。可以通过该开关触发即可



